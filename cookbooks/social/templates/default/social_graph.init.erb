#!/bin/env bash
set -e
#
# init script for a Java application
# - it is dynamically generated by Chef for FBGRAPH
# Check the application status
#
# This function checks if the application is running

PIDFILE=/var/run/social_graph/<%= @app %>.pid

export JAVA_HOME=/usr/lib/jvm/jdk1.7.0_17
export PATH=$JAVA_HOME/bin:$PATH
export serviceUser=<%= node[:social_graph][:user] %>
export serviceGroup=<%= node[:social_graph][:group] %>
export SHELL=/bin/bash

check_status() {

    pidfile=/var/run/social_graph/<%= @app %>.pid
    # Test if pid file has contents

    if [[ -s $pidfile ]] ; then
        echo 1
    else
        echo 0
    fi
}

# Starts the application
start() {

    # At first checks if the application is already started calling the check_status
    # function
    running=`check_status`

    if [ $running -ne 0 ] ; then
        echo "The application (<%= @app %>) is already started"
        exit 0
    fi

    # If the application isn't running, starts it
    echo -n "Starting application (<%= @app %>): "

    # Redirects default and error output to a log file
    BASEDIR="<%= @basedir %>"
    cmd="nohup $JAVA_HOME/bin/java -Xmx1024M -Dpidfile=$PIDFILE -Dlog4j.configuration=file:///$BASEDIR/log4j.xml -Djava.rmi.server.hostname=<%= node[:ipaddress] %> -Dcom.sun.management.jmxremote.port=8995 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -cp <%= @jarfile %> com.ccrd.amqp.SocialGraphConsumer $BASEDIR/env.properties > /var/log/<%= @app %>/<%= @app %>.log 2>&1 &  echo \$! > $PIDFILE"
    su -m $serviceUser -s $SHELL -c "$cmd" || return 1
    echo "OK"
}

# Stops the application
stop() {
    # Kills the application process
    echo -n "Stopping application (<%= @app %>): "
    if [ -f $PIDFILE ] ; then
        kill $(cat $PIDFILE)
        rm -f $PIDFILE
        sleep 1
    fi
    echo "OK"
}

# Show the application status
status() {

    # The check_status function, again...


    # If the PID was returned means the application is running
    if [ -f $PIDFILE ] ; then
        echo "Application (<%= @app %>) is started"
    else
        echo "Application (<%= @app %>) is stopped"
    fi
}

# Main logic, a simple case to call functions
case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    restart|reload)
        stop
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload|status}"
        exit 0
esac

exit 0
