#!/bin/env bash
set -e
#
# init script for a Java application
# - it is dynamically generated by Chef for FBGRAPH
# Check the application status
#
# This function checks if the application is running
check_status() {

    pidfile=/var/run/fbgraph/<%= @app %>.pid
    # Test if pid file has contents

    if [[ -s $pidfile ]] ; then
        echo 1
    else
        echo 0
    fi
}

# Starts the application
start() {

    # At first checks if the application is already started calling the check_status
    # function
    running=`check_status`

    if [ $running -ne 0 ] ; then
        echo "The application (<%= @app %>) is already started"
        exit 0
    fi

    # If the application isn't running, starts it
    echo -n "Starting application (<%= @app %>): "

    # Redirects default and error output to a log file
    HOST=`ifconfig | grep 10.5.40 | awk '{print $2}' | cut -d: -f2`
    BASEDIR="<%= @basedir %>"
    java -Xmx1024M -Dlog4j.configuration=file:///$BASEDIR/log4j.xml -Djava.rmi.server.hostname=$HOST -Dcom.sun.management.jmxremote.port=8995 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -cp $BASEDIR/* com.ccrd.amqp.FBGraphConsumer $BASEDIR/env.properties

    >> /dev/null 2>&1 &
    echo $! > /var/run/fbgraph/<%= @app %>.pid
    echo "OK"
}

# Stops the application
stop() {
    # Kills the application process
    echo -n "Stopping application (<%= @app %>): "
    kill -9 $(cat /var/run/fbgraph/<%= @app %>.pid)
    rm -f /var/run/fbgraph/<%= @app %>.pid
    echo "OK"
}

# Show the application status
status() {

    # The check_status function, again...
    running=`check_status`

    # If the PID was returned means the application is running
    if [ $running -ne 0 ] ; then
        echo "Application (<%= @app %>) is started"
    else
        echo "Application (<%= @app %>) is stopped"
    fi

}

# Main logic, a simple case to call functions
case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    restart|reload)
        stop
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload|status}"
        exit 0
esac

exit 0
